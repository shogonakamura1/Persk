{% extends 'base.html' %}

{% block title %}Persk - Timeline{% endblock %}

{% block content %}
<!-- Timeline Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Timeline</h5>
            </div>
            <div class="card-body">
                <div id="timelineList">
                    <div class="text-center text-muted">
                        <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                        <p class="mt-2">„Ç§„Éô„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    </div>
                </div>
                <div id="timelineLoading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* „Çø„Ç§„É†„É©„Ç§„É≥„Éö„Éº„Ç∏Â∞ÇÁî®„Çπ„Çø„Ç§„É´ */
body {
    background-color: #f8f9fa;
}

.main-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.main-column {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
}

/* „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜ */
.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.header-text h2 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
    margin: 0;
}

.header-text p {
    color: #666;
    margin: 0;
    font-size: 0.9rem;
}

/* „Çø„Ç§„É†„É©„Ç§„É≥„Ç¢„Ç§„ÉÜ„É† */
.timeline-item {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 6px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.timeline-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.15);
    border-color: #667eea;
}

.timeline-item.task-start::before {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.timeline-item.task-stop::before {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

.timeline-item.task-complete::before {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
}

.timeline-item.task-shared::before {
    background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.timeline-user {
    font-weight: 600;
    color: #667eea;
    font-size: 1.1rem;
}

.timeline-time {
    font-size: 0.9rem;
    color: #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 500;
}

.timeline-content {
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    color: #333;
    line-height: 1.6;
    font-weight: 500;
}

.timeline-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.timeline-item:hover .timeline-actions {
    opacity: 1;
}

.like-button {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    transition: color 0.3s ease;
}

.like-button:hover {
    color: #dc3545;
}

.like-button.liked {
    color: #dc3545;
}

.delete-button {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    transition: color 0.3s ease;
}

.delete-button:hover {
    color: #dc3545;
}

.timeline-item.own-item .delete-button {
    opacity: 1;
}

.timeline-item:not(.own-item) .delete-button {
    display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let timelineCursor = null;
let isLoading = false;
let hasMoreData = true;

// TimelineË™≠„ÅøËæº„Åø
function loadTimeline() {
    if (isLoading || !hasMoreData) return;
    
    isLoading = true;
    document.getElementById('timelineLoading').style.display = 'block';
    
    let url = '/api/timeline/?limit=50';
    if (timelineCursor) {
        url += `&cursor=${timelineCursor}`;
    }
    
    fetch(url, {
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Timeline API Response:', data);
        if (data.items && data.items.length > 0) {
            renderTimelineItems(data.items);
            timelineCursor = data.next_cursor;
            
            // Ê¨°„ÅÆ„Ç´„Éº„ÇΩ„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åì„Çå‰ª•‰∏ä„Éá„Éº„Çø„Åå„Å™„ÅÑ„Åì„Å®„ÇíÁ§∫„Åô
            if (!data.next_cursor) {
                hasMoreData = false;
                console.log('No more timeline data available');
            }
        } else {
            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åì„Çå‰ª•‰∏ä„Éá„Éº„Çø„Åå„Å™„ÅÑ„Åì„Å®„ÇíÁ§∫„Åô
            hasMoreData = false;
            console.log('No timeline data received');
        }
    })
    .catch(error => {
        console.error('TimelineË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        showToast('Timeline„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
    })
    .finally(() => {
        isLoading = false;
        document.getElementById('timelineLoading').style.display = 'none';
    });
}

// Timeline„Ç¢„Ç§„ÉÜ„É†Ë°®Á§∫
function renderTimelineItems(items) {
    const container = document.getElementById('timelineList');
    
    if (container.querySelector('.text-muted')) {
        container.innerHTML = '';
    }
    
    items.forEach(item => {
        const itemElement = createTimelineItem(item);
        container.appendChild(itemElement);
    });
}

// Timeline„Ç¢„Ç§„ÉÜ„É†‰ΩúÊàê
function createTimelineItem(item) {
    console.log('Creating timeline item:', item);
    const div = document.createElement('div');
    div.className = `timeline-item ${item.kind}`;
    if (item.user === '{{ user.username }}') {
        div.classList.add('own-item');
    }
    
    const time = new Date(item.ts).toLocaleString('ja-JP');
    const kindText = getKindText(item.kind, item);
    
    div.innerHTML = `
        <div class="timeline-header">
            <span class="timeline-user">${item.user}</span>
            <span class="timeline-time">${time}</span>
        </div>
        <div class="timeline-content">
            ${kindText.replace(/\n/g, '<br>')}
        </div>
        <div class="timeline-actions">
            <button class="like-button ${item.liked ? 'liked' : ''}" onclick="toggleLike(${item.id})">
                <i class="bi bi-heart${item.liked ? '-fill' : ''}"></i>
                <span class="like-count">${item.likes}</span>
            </button>
            <button class="delete-button" onclick="deleteTimelineItem(${item.id})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    
    return div;
}

// „Ç§„Éô„É≥„ÉàÁ®ÆÂà•„ÉÜ„Ç≠„Çπ„ÉàÂèñÂæó
function getKindText(kind, item) {
    if (kind === 'task_shared') {
        // ÂÖ±Êúâ„Ç§„Éô„É≥„Éà„ÅÆÂ†¥Âêà„ÅØÁâπÂà•„Å™Ë°®Á§∫
        const taskTitle = item.task_title || '„Çø„Çπ„ÇØ';
        const estimateMin = item.estimate_min || 0;
        const importance = item.importance || 0;
        const username = item.username || '„É¶„Éº„Ç∂„Éº';
        
        // ÈáçË¶ÅÂ∫¶„Å´Âøú„Åò„ÅüÁµµÊñáÂ≠ó„ÇíËøΩÂä†
        const importanceEmoji = importance >= 3 ? 'üî•' : importance >= 2 ? '‚ö°' : importance >= 1 ? 'üìå' : 'üìù';
        
        // „É©„É≥„ÉÄ„É†„Å™Âä±„Åæ„Åó„É°„ÉÉ„Çª„Éº„Ç∏
        const encouragementMessages = [
            '„Åø„Çì„Å™„ÇÇÈ†ëÂºµ„Çç„ÅÜÔºÅ üí™',
            'Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÊûú„Åß„Åô„Å≠ÔºÅ üåü',
            'Ê¨°„ÅØ„ÅÇ„Å™„Åü„ÅÆÁï™„Åß„ÅôÔºÅ üöÄ',
            '„ÉÅ„Éº„É†„ÉØ„Éº„ÇØ„ÅßÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ ü§ù',
            '‰∏ÄÊ≠©„Åö„Å§ÈÄ≤„Çì„Åß„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜÔºÅ üë£',
            '„Åø„Çì„Å™„Åß‰∏ÄÁ∑í„Å´ÊàêÈï∑„Åó„Åæ„Åó„Çá„ÅÜÔºÅ üå±',
            '‰ªäÊó•„ÇÇ‰∏ÄÊó•È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ ‚òÄÔ∏è',
            'Â∞è„Åï„Å™ÈÄ≤Ê≠©„ÇÇÂ§ß„Åç„Å™ÊàêÊûú„Åß„ÅôÔºÅ ‚ú®'
        ];
        const randomMessage = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
        
        return `${username}„Åï„Çì„Åå„Çø„Çπ„ÇØ„ÇíÁµÇ„Çè„Çâ„Åõ„Åæ„Åó„ÅüÔºÅÔºÅ üéâ\n${importanceEmoji} ${taskTitle}\n‚è±Ô∏è „Åã„Åã„Å£„ÅüÊôÇÈñì: ${estimateMin}ÂàÜ\n${randomMessage}`;
    }
    
    const kindMap = {
        'task_start': 'üöÄ „Çø„Çπ„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü',
        'task_stop': '‚è∏Ô∏è „Çø„Çπ„ÇØ„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü',
        'task_complete': 'üéâ „Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ',
        'subtask_start': '‚ñ∂Ô∏è „Çµ„Éñ„Çø„Çπ„ÇØ„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü',
        'subtask_complete': '‚úÖ „Çµ„Éñ„Çø„Çπ„ÇØ„ÇíÂÆå‰∫Ü„Åó„Åæ„Åó„Åü'
    };
    return kindMap[kind] || kind;
}

// „ÅÑ„ÅÑ„Å≠„Éà„Ç∞„É´
function toggleLike(eventId) {
    fetch(`/api/timeline/${eventId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            const likeButton = document.querySelector(`[onclick="toggleLike(${eventId})"]`);
            const icon = likeButton.querySelector('i');
            const count = likeButton.querySelector('.like-count');
            
            if (data.liked) {
                likeButton.classList.add('liked');
                icon.className = 'bi bi-heart-fill';
            } else {
                likeButton.classList.remove('liked');
                icon.className = 'bi bi-heart';
            }
            
            count.textContent = data.count;
        }
    })
    .catch(error => {
        console.error('„ÅÑ„ÅÑ„Å≠„Ç®„É©„Éº:', error);
        showToast('üòÖ „ÅÑ„ÅÑ„Å≠„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºÅ', 'error');
    });
}

// TimelineÂâäÈô§
function deleteTimelineItem(eventId) {
    if (!confirm('„Åì„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        return;
    }
    
    fetch(`/api/timeline/${eventId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            const item = document.querySelector(`[onclick="deleteTimelineItem(${eventId})"]`).closest('.timeline-item');
            item.style.opacity = '0';
            setTimeout(() => {
                item.remove();
            }, 300);
            showToast('üóëÔ∏è „Ç§„Éô„É≥„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', 'success');
        }
    })
    .catch(error => {
        console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
        showToast('üòÖ ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºÅ', 'error');
    });
}

// ÁÑ°Èôê„Çπ„ÇØ„É≠„Éº„É´
function handleScroll() {
    if (hasMoreData && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
        loadTimeline();
    }
}

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    loadTimeline();
    window.addEventListener('scroll', handleScroll);
});

// „Éà„Éº„Çπ„ÉàË°®Á§∫Èñ¢Êï∞ÔºàÁ∞°ÊòìÁâàÔºâ
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
